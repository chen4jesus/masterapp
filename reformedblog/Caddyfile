# Default site configuration (for development/IP-based access)
:80 {
    # Handle OPTIONS requests for CORS preflight
    @options {
        method OPTIONS
    }
    respond @options 204

    # Proxy API requests to Node.js server
    handle /api/* {
        reverse_proxy localhost:3000
    }

    # Serve static files
    root * /app/public
    file_server

    # Enable gzip compression
    encode gzip

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        # CORS headers for API
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, X-API-Key"
    }

    # Cache static assets
    @static {
        path *.jpg *.jpeg *.png *.gif *.ico *.css *.js *.svg *.woff *.woff2 *.ttf *.eot *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # HTML files should not be cached
    @html {
        path *.html
    }
    header @html Cache-Control "public, max-age=0, must-revalidate"

    # Handle clean URLs (try file without .html extension)
    @cleanPath {
        not path *.html /*/*
        file {
            try_files {path}.html
        }
    }
    rewrite @cleanPath {path}.html
}

# Production configuration with automatic HTTPS
# Uncomment and replace with your domain:
# your-domain.com, www.your-domain.com {
#     # Redirect www to non-www
#     @www {
#         host www.your-domain.com
#     }
#     redir @www https://your-domain.com{uri} permanent
#
#     # Handle OPTIONS requests for CORS preflight
#     @options {
#         method OPTIONS
#     }
#     respond @options 204
#
#     # Proxy API requests to Node.js server
#     handle /api/* {
#         reverse_proxy localhost:3000
#     }
#
#     # Serve static files
#     root * /usr/share/caddy/html
#     file_server
#
#     encode gzip
#
#     header {
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#         X-XSS-Protection "1; mode=block"
#         Referrer-Policy "strict-origin-when-cross-origin"
#         Access-Control-Allow-Origin "*"
#         Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
#         Access-Control-Allow-Headers "Content-Type, X-API-Key"
#     }
#
#     @static {
#         path *.jpg *.jpeg *.png *.gif *.ico *.css *.js *.svg *.woff *.woff2 *.ttf *.eot *.webp
#     }
#     header @static Cache-Control "public, max-age=31536000, immutable"
#
#     @html {
#         path *.html
#     }
#     header @html Cache-Control "public, max-age=0, must-revalidate"
#
#     @cleanPath {
#         not path *.html /*/*
#         file {
#             try_files {path}.html
#         }
#     }
#     rewrite @cleanPath {path}.html
# }
